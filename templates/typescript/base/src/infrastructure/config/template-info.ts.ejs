import { DataProviderDescriptor, DependencyStatus, FeatureDescriptor } from '../../domain/status/system-info';

const features: FeatureDescriptor[] = <%- JSON.stringify(
  selectedFeatures.map((feature) => ({
    key: feature.key,
    name: feature.name,
    description: feature.description,
    summary: feature.summary,
  })),
  null,
  2
) %>;

const dataProviders: DataProviderDescriptor[] = <%- JSON.stringify(
  selectedDataProviders.map((provider) => ({
    key: provider.key,
    name: provider.name,
    summary: provider.summary,
    kind: provider.kind,
    status: provider.defaultStatus,
    details: provider.statusDescription,
  })),
  null,
  2
) %>;

const dependencies: DependencyStatus[] = [
  {
    name: 'http',
    status: 'ok',
    details: 'Serveur Express initialisé.',
  },
  {
    name: 'documentation',
    status: 'ok',
    details: 'Documentation Swagger disponible sur /docs.',
  },
  {
    name: 'database',
    status: <%- selectedDataProviders.length > 0 ? `'warning'` : `'skipped'` %>,
    details: <%- JSON.stringify(
      selectedDataProviders.length > 0
        ? (hasPrisma
            ? "Prisma/PostgreSQL prêt : exécutez `npm run prisma:generate`, `npm run prisma:migrate` puis `npm run db:seed`."
            : 'Clients installés. Configurez vos adapters pour activer la connexion.')
        : "Aucune base de données n'est configurée par défaut. Ajoutez vos adapters lorsque vous en aurez besoin."
    ) %>,
  },
];

<% if (features.includes('auth')) { %>
dependencies.push({
  name: 'auth',
  status: 'ok',
  details: "Flux d'authentification JWT actif.",
});
<% } %>
<% if (features.includes('userCrud')) { %>
dependencies.push({
  name: 'userRepository',
  status: 'ok',
  details: <%- JSON.stringify(hasPrisma ? 'Gestion CRUD des utilisateurs via Prisma/PostgreSQL.' : 'Gestion CRUD des utilisateurs en mémoire activée.') %>,
});
<% } %>
<% if (features.includes('clientPortal')) { %>
dependencies.push({
  name: 'clientPortal',
  status: 'ok',
  details: 'Routes client protégées prêtes à l\'emploi.',
});
<% } %>
<% if (features.includes('adminPortal')) { %>
dependencies.push({
  name: 'adminPortal',
  status: 'ok',
  details: 'Endpoints administrateur sécurisés disponibles.',
});
<% } %>

<% selectedDataProviders.forEach((provider) => { %>
dependencies.push(<%- JSON.stringify({
  name: provider.name,
  status: provider.defaultStatus,
  details: provider.statusDescription,
}) %>);
<% }); %>

export const templateInfo = {
  projectName: '<%- projectName %>',
  features,
  dataProviders,
  dependencies,
} as const;

export type GeneratedFeatureDescriptor = (typeof templateInfo.features)[number];
export type GeneratedDependencyStatus = (typeof templateInfo.dependencies)[number];
export type GeneratedDataProviderDescriptor = (typeof templateInfo.dataProviders)[number];

